<!DOCTYPE html>
<html>
<head>
   <title>EZCheckin</title>
   <link href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
   <script src="http://apps.bdimg.com/libs/jquery/2.0.0/jquery.min.js"></script>
   <script src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>

    <meta name="viewport" content="width=device-width, 
                                     initial-scale=1.0, 
                                     maximum-scale=1.0, 
                                     user-scalable=no">
</head>
<body>

<h1>开始签到</h1>
<p>不要乱动，安静地等一会</p>
<div id="visibility">  
</div>  
<div id="nowtime">  
</div>  
<div id="divNowTime">  
</div>  
 
<div id="divResult">  
</div> 

<form  method="post">
{% csrf_token %}   
      <input id="student_number" type="hidden" name="studentNumber" value="{{ studentNumber }}">
      <input id="course_number" type="hidden" name="courseNumber" value="{{ courseNumber }}">
      <input id="heartbeat" type="hidden" name="heartbeat" value=0>
      <input id="heartbeatRequired" type="hidden" name="heartbeatRequired" value=100>
</form>

<script type="text/javascript" language="javascript">

		var hidden, state, visibilityChange; 
		if (typeof document.hidden !== "undefined") {
			hidden = "hidden";
			visibilityChange = "visibilitychange";
			state = "visibilityState";
		} else if (typeof document.mozHidden !== "undefined") {
			hidden = "mozHidden";
			visibilityChange = "mozvisibilitychange";
			state = "mozVisibilityState";
		} else if (typeof document.msHidden !== "undefined") {
			hidden = "msHidden";
			visibilityChange = "msvisibilitychange";
			state = "msVisibilityState";
		} else if (typeof document.webkitHidden !== "undefined") {
			hidden = "webkitHidden";
			visibilityChange = "webkitvisibilitychange";
			state = "webkitVisibilityState";
		} else{
                        $("#visibility").text("undefined");  
                }
		
                function visibilityChangeReaction() {
			document.title = document[state];
    			if (document.hidden) {   
                        	$("#visibility").append("hidden");  
   			} else  {
                        	$("#visibility").append("visible");
   			}
                }
		document.addEventListener("visibilityChange", visibilityChangeReaction);                 
                document.addEventListener("webkitvisibilitychange", visibilityChangeReaction);    
                document.addEventListener("msvisibilitychange", visibilityChangeReaction); 
alert('You were away for')
document.title = state + " " + document[state];

    $(document).ready(function(){  
        setInterval("startRequest()", 3000);  
    });  




    function startRequest(){ 
        if($("#heartbeat").val() >= 100){
            getSuccessPage();
        }
        else{
            getHeartbeat();
        }
    }  

    function getSuccessPage(){
        $("#divResult").text("success"); 
        window.location.href='success/';
    }

    function getHeartbeat(){
        $("#nowtime").text((new Date()).toString());  
        $('#divNowTime').text((new Date()).toLocaleDateString() + " " + (new Date()).toLocaleTimeString());  
        var student_number = $("#student_number").val();
        var course_number = $("#course_number").val();
        $.ajax({  
            url: "heartbeat/",  
            type: 'POST',  
            data: {  
                student_number: student_number, 
                course_number: course_number 
            },  
            success: function (responseText) { 
                $("#divResult").text(responseText); 
                $("#heartbeat").val(responseText); 
            }  
        });
    }

</script>  

</body>
</html>
</body>
</html>
